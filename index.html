<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Room Geofence</title>
<style>
  body {
    font-family: sans-serif;
    text-align: center;
    padding: 2rem;
    background: #f7f8fa;
  }
  #restrictedButton {
    padding: 1rem 2rem;
    font-size: 1.2rem;
    border: none;
    border-radius: 10px;
    background: #4CAF50;
    color: white;
  }
  #restrictedButton:disabled {
    background: #ccc;
  }
  .status {
    margin-top: 1rem;
    font-size: 1.1rem;
  }
</style>
</head>
<body>

<h2>Room Geofence Test</h2>
<button id="restrictedButton" disabled>Click Me</button>
<p id="status" class="status">Waiting for location...</p>
<p id="coords" class="status"></p>

<script>
// === Room polygon coordinates (your corner measurements) ===
const roomPolygon = [
  [6.244521, 6.208141],
  [6.244476, 6.208149],
  [6.244477, 6.208152],
  [6.244473, 6.208153],
  [6.244457, 6.208160],
  [6.244456, 6.208156],
];

// === Compute the room center (average of corners) ===
const roomCenter = roomPolygon.reduce(
  (acc, p) => [acc[0] + p[0], acc[1] + p[1]],
  [0, 0]
).map(v => v / roomPolygon.length);

// === Adjust this radius to roughly cover your room (in meters) ===
const roomRadiusMeters = 8;

// === Utility: Haversine distance between two lat/lon pairs in meters ===
function distanceMeters(a, b) {
  const R = 6371000;
  const dLat = (b[0] - a[0]) * Math.PI / 180;
  const dLon = (b[1] - a[1]) * Math.PI / 180;
  const lat1 = a[0] * Math.PI / 180, lat2 = b[0] * Math.PI / 180;
  const x = dLon * Math.cos((lat1 + lat2) / 2);
  const d = Math.sqrt(dLat * dLat + x * x) * R;
  return d;
}

// === Check if inside the circular boundary (room + accuracy + buffer) ===
function isInsideRoom(pt, accuracy) {
  const d = distanceMeters(pt, roomCenter);
  const buffer = 3; // extra meters to absorb small GPS jumps
  return d <= (roomRadiusMeters + accuracy + buffer);
}

// === Smooth position state ===
const SMOOTH_WINDOW = 5;  // number of last readings to average
const OUT_CONSENSUS = 3;  // how many "outside" readings before we switch

let lastPositions = [];
let outsideCount = 0;
let lastInside = false;

const statusEl = document.getElementById("status");
const coordsEl = document.getElementById("coords");
const button = document.getElementById("restrictedButton");

function handlePosition(p) {
  const lat = p.latitude;
  const lon = p.longitude;
  const acc = p.accuracy || 5;

  coordsEl.textContent = `Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)}, ±${acc.toFixed(1)}m`;

  // store position for smoothing
  lastPositions.push([lat, lon]);
  if (lastPositions.length > SMOOTH_WINDOW) lastPositions.shift();

  // average position
  const avg = lastPositions.reduce((a,b)=>[a[0]+b[0], a[1]+b[1]],[0,0])
              .map(v=>v/lastPositions.length);

  const inside = isInsideRoom(avg, acc);

  if (inside) {
    outsideCount = 0;
    if (!lastInside) {
      statusEl.textContent = "✅ You are inside the room.";
      button.disabled = false;
    }
    lastInside = true;
  } else {
    outsideCount++;
    if (outsideCount >= OUT_CONSENSUS && lastInside) {
      statusEl.textContent = "❌ You are outside the room.";
      button.disabled = true;
      lastInside = false;
    }
  }
}

// === Start continuous geolocation watcher ===
function startWatching() {
  let watchId = null;
  const options = { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 };

  function restartWatch() {
    if (watchId !== null) navigator.geolocation.clearWatch(watchId);
    watchId = navigator.geolocation.watchPosition(
      pos => handlePosition(pos.coords),
      err => {
        statusEl.textContent = "Error: " + err.message;
        setTimeout(restartWatch, 5000);
      },
      options
    );
  }

  restartWatch();

  // restart every 60 seconds to prevent throttling
  setInterval(restartWatch, 60000);
}

if (navigator.geolocation) {
  startWatching();
} else {
  statusEl.textContent = "Geolocation not supported by this browser.";
}

button.addEventListener('click', () => {
  alert('You clicked inside the room!');
});
</script>

</body>
</html>
